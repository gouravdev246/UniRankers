{% extends 'base.html' %}
{% block content %}
<section class="py-5" style="background: linear-gradient(135deg, var(--orange-light), #fff);">
  <div class="container">
    <div class="row mb-4 align-items-center">
      <div class="col">
        <h1 class="h3" style="color: var(--orange-dark);">Help and Grow</h1>
        <p class="text-muted mb-0">Create requests and find collaborators.</p>
      </div>
      <div class="col-auto">
        <a href="{% url 'profile' %}" class="btn btn-outline-dark">My Profile</a>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-12 col-lg-5">
        <div class="card shadow-sm">
          <div class="card-header" style="background: linear-gradient(135deg, var(--orange-primary), var(--orange-dark));">
            <h2 class="h6 m-0 text-white">Create Request</h2>
          </div>
          <div class="card-body">
            <form method="post" action="{% url 'helpgrow_create' %}" class="row g-3">
              {% csrf_token %}
              <div class="col-12">
                <label class="form-label" for="id_title">Title</label>
                {{ form.title }}
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="id_request_type">Type</label>
                {{ form.request_type }}
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="id_urgency">Urgency</label>
                {{ form.urgency }}
              </div>
              <div class="col-12">
                <label class="form-label" for="id_description">Description</label>
                {{ form.description }}
              </div>
              <div class="col-12">
                <label class="form-label" for="id_required_skills">Required Skills</label>
                {{ form.required_skills }}
              </div>
              <div class="col-12">
                <label class="form-label" for="id_tags">Tags</label>
                {{ form.tags }}
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-warning" style="background: linear-gradient(135deg, var(--orange-primary), var(--orange-dark)); border:none;">Create</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-7">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, var(--orange-primary), var(--orange-dark));">
            <h2 class="h6 m-0 text-white">Public Requests</h2>
            <form method="get" class="d-flex gap-2">
              <select class="form-select form-select-sm" name="type">
                <option value="">All Types</option>
                <option value="TEAM">Team Formation</option>
                <option value="GUIDANCE">Guidance Needed</option>
                <option value="HACKATHON">Hackathon Partner</option>
                <option value="OTHER">Other</option>
              </select>
              <select class="form-select form-select-sm" name="urgency">
                <option value="">All Urgency</option>
                <option value="HIGH">High</option>
                <option value="MEDIUM">Medium</option>
                <option value="LOW">Low</option>
              </select>
              <select class="form-select form-select-sm" name="order">
                <option value="date">Newest</option>
                <option value="urgency">By Urgency</option>
              </select>
              <button class="btn btn-light btn-sm" type="submit">Filter</button>
            </form>
          </div>
          <div class="card-body" style="max-height: 70vh; overflow:auto;">
            {% for r in requests %}
              <div class="border rounded p-3 mb-3" data-id="{{ r.id }}">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-semibold">{{ r.title }} <span class="badge bg-secondary ms-2">{{ r.get_request_type_display }}</span></div>
                    <div class="text-muted small">By <a href="{% url 'public_profile' r.author.id %}" class="text-decoration-none" aria-label="View {{ r.author.name }} profile">{{ r.author.name }}</a> • {{ r.created_at|date:"M d, Y H:i" }} • <span class="badge bg-warning text-dark">{{ r.urgency }}</span> • {{ r.status }}</div>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-success accept-btn">Accept/Join</button>
                    <button class="btn btn-sm btn-outline-secondary bookmark-btn">Bookmark</button>
                    <button class="btn btn-sm btn-outline-danger report-btn">Report</button>
                    {% if r.author_id == request.user.id %}
                      <button class="btn btn-sm btn-outline-danger delete-btn">Delete</button>
                    {% endif %}
                  </div>
                </div>
                <div class="mt-2">
                  <div class="desc-short">{{ r.description|truncatechars:160 }}</div>
                  <div class="desc-full d-none">{{ r.description }}</div>
                  <a href="#" class="read-more">Read More</a>
                </div>
                <div class="mt-2 text-muted small">Skills: {{ r.required_skills }} • Tags: {{ r.tags }}</div>
                <div class="mt-3">
                  <div class="d-flex align-items-center gap-2 mb-2">
                    {% if request.user.profile_photo %}
                      <img src="{{ request.user.profile_photo.url }}" alt="Avatar" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
                    {% endif %}
                    <input type="text" class="form-control form-control-sm comment-input" maxlength="500" placeholder="Write a comment...">
                    <button class="btn btn-sm btn-warning comment-submit" style="background: linear-gradient(135deg, var(--orange-primary), var(--orange-dark)); border:none;">Post</button>
                  </div>
                  <div class="comments small"></div>
                </div>
                {% if r.team %}
                  <div class="mt-3 p-2 border rounded">
                    <div class="fw-semibold">Team</div>
                    <div class="small">Members: {{ r.team.memberships.count }}
                      {% for m in r.team.memberships.all %}
                        • {{ m.user.name }}{% if m.approved %} (approved){% endif %}
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
              </div>
            {% empty %}
              <p class="text-muted">No requests yet.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  function getCookie(name){const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return v?v.pop():''}
  document.addEventListener('DOMContentLoaded',()=>{
    document.querySelectorAll('.accept-btn').forEach(b=>{b.addEventListener('click',async()=>{const card=b.closest('[data-id]');const id=card.dataset.id;await fetch(`/helpgrow/${id}/accept/`,{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken')}});})})
    document.querySelectorAll('.bookmark-btn').forEach(b=>{b.addEventListener('click',async()=>{const card=b.closest('[data-id]');const id=card.dataset.id;await fetch(`/helpgrow/${id}/bookmark/`,{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken')}});})})
    document.querySelectorAll('.report-btn').forEach(b=>{b.addEventListener('click',async()=>{const card=b.closest('[data-id]');const id=card.dataset.id;const reason=prompt('Reason');if(!reason)return;await fetch(`/helpgrow/${id}/report/`,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':getCookie('csrftoken')},body:`reason=${encodeURIComponent(reason)}`});})})
    document.querySelectorAll('.comment-submit').forEach(b=>{b.addEventListener('click',async()=>{const wrapper=b.closest('[data-id]');const id=wrapper.dataset.id;const input=wrapper.querySelector('.comment-input');const list=wrapper.querySelector('.comments');const content=(input.value||'').trim();if(!content)return; b.disabled=true;const r=await fetch(`/helpgrow/${id}/comment/`,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':getCookie('csrftoken')},body:`content=${encodeURIComponent(content)}`});b.disabled=false; if(r.ok){const j=await r.json();const el=document.createElement('div');el.innerHTML=`<div><span class='fw-semibold'>${j.user}</span> <span class='text-muted'>${new Date(j.created_at).toLocaleString()}</span></div><div>${j.content}</div>`;list.prepend(el);input.value=''} })})
  })
</script>
<script>
  function getCookie(name){const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return v?v.pop():''}
  function setBtnState(btn, text, disabled){btn.textContent=text;btn.disabled=!!disabled}
  document.addEventListener('DOMContentLoaded',()=>{
    document.addEventListener('click',async(e)=>{
      const t=e.target;
      if(t.matches('.accept-btn')){
        e.preventDefault(); if(t.disabled) return;
        const card=t.closest('[data-id]'); const id=card?.dataset.id; if(!id) return;
        try{setBtnState(t,'Processing...',true);const r=await fetch(`/helpgrow/${id}/accept/`,{method:'POST',credentials:'same-origin',headers:{'X-CSRFToken':getCookie('csrftoken')}});if(!r.ok){setBtnState(t,'Accept/Join',false);alert('Failed to accept');return}setBtnState(t,'Accepted',true);t.setAttribute('aria-busy','true')}catch(err){setBtnState(t,'Accept/Join',false);alert('Network error')}}
      else if(t.matches('.bookmark-btn')){
        e.preventDefault(); const card=t.closest('[data-id]'); const id=card?.dataset.id; if(!id) return;
        try{setBtnState(t,'Saving...',true);const r=await fetch(`/helpgrow/${id}/bookmark/`,{method:'POST',credentials:'same-origin',headers:{'X-CSRFToken':getCookie('csrftoken')}});const ok=r.ok;const j= ok? await r.json():{};t.classList.toggle('active',j.bookmarked);t.textContent=j.bookmarked?'Bookmarked':'Bookmark';t.disabled=false;t.removeAttribute('aria-busy');}catch(err){setBtnState(t,'Bookmark',false);alert('Failed to bookmark')}}
      else if(t.matches('.report-btn')){
        e.preventDefault(); const card=t.closest('[data-id]'); const id=card?.dataset.id; if(!id) return; const reason=prompt('Reason'); if(!reason) return;
        try{setBtnState(t,'Reporting...',true);const r=await fetch(`/helpgrow/${id}/report/`,{method:'POST',credentials:'same-origin',headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':getCookie('csrftoken')},body:`reason=${encodeURIComponent(reason)}`});setBtnState(t,r.ok?'Reported':'Report',r.ok); if(!r.ok) alert('Failed to report')}catch(err){setBtnState(t,'Report',false);alert('Network error')}}
      else if(t.matches('.delete-btn')){
        e.preventDefault(); const card=t.closest('[data-id]'); const id=card?.dataset.id; if(!id) return; if(!confirm('Delete this request?')) return;
        try{setBtnState(t,'Deleting...',true);const r=await fetch(`/helpgrow/${id}/delete/`,{method:'POST',credentials:'same-origin',headers:{'X-CSRFToken':getCookie('csrftoken')}});if(!r.ok){setBtnState(t,'Delete',false);alert('Failed to delete');return}card.remove()}catch(err){setBtnState(t,'Delete',false);alert('Network error')}}
      else if(t.matches('.comment-submit')){
        e.preventDefault(); const wrapper=t.closest('[data-id]');const id=wrapper?.dataset.id; if(!id) return; const input=wrapper.querySelector('.comment-input'); const list=wrapper.querySelector('.comments'); const content=(input?.value||'').trim(); if(!content) return;
        try{setBtnState(t,'Posting...',true);const r=await fetch(`/helpgrow/${id}/comment/`,{method:'POST',credentials:'same-origin',headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':getCookie('csrftoken')},body:`content=${encodeURIComponent(content)}`});setBtnState(t,'Post',false); if(r.ok){const j=await r.json();const el=document.createElement('div');el.innerHTML=`<div><span class='fw-semibold'>${j.user}</span> <span class='text-muted'>${new Date(j.created_at).toLocaleString()}</span></div><div>${j.content}</div>`;list?.prepend(el); if(input) input.value='';} else {alert('Failed to comment')}}catch(err){setBtnState(t,'Post',false);alert('Network error')}}
      else if(t.matches('.read-more')){
        e.preventDefault(); const card=t.closest('[data-id]'); if(!card) return; const short=card.querySelector('.desc-short'); const full=card.querySelector('.desc-full'); if(!short||!full) return; const isHidden=full.classList.contains('d-none'); if(isHidden){full.classList.remove('d-none'); t.textContent='Read Less'} else {full.classList.add('d-none'); t.textContent='Read More'}
      }
    })
  })
</script>
{% endblock content %}
