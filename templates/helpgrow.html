{% extends 'base.html' %}
{% block content %}
<section class="py-5" style="background: linear-gradient(135deg, var(--orange-light), #fff);">
  <div class="container">
    <div class="row mb-4 align-items-center">
      <div class="col">
        <h1 class="h3" style="color: var(--orange-dark);">Help and Grow</h1>
        <p class="text-muted mb-0">Create requests and find collaborators.</p>
      </div>
      <div class="col-auto">
        <a href="{% url 'profile' %}" class="btn btn-outline-dark">My Profile</a>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-12 col-lg-5">
        <div class="card shadow-sm">
          <div class="card-header" style="background: linear-gradient(135deg, var(--orange-primary), var(--orange-dark));">
            <h2 class="h6 m-0 text-white">Create Request</h2>
          </div>
          <div class="card-body">
            <form method="post" action="{% url 'helpgrow_create' %}" class="row g-3">
              {% csrf_token %}
              <div class="col-12">
                <label class="form-label" for="id_title">Title</label>
                {{ form.title }}
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="id_request_type">Type</label>
                {{ form.request_type }}
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="id_urgency">Urgency</label>
                {{ form.urgency }}
              </div>
              <div class="col-12">
                <label class="form-label" for="id_description">Description</label>
                {{ form.description }}
              </div>
              <div class="col-12">
                <label class="form-label" for="id_required_skills">Required Skills</label>
                {{ form.required_skills }}
              </div>
              <div class="col-12">
                <label class="form-label" for="id_tags">Tags</label>
                {{ form.tags }}
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-warning" style="background: linear-gradient(135deg, var(--orange-primary), var(--orange-dark)); border:none;">Create</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-7">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, var(--orange-primary), var(--orange-dark));">
            <h2 class="h6 m-0 text-white">Public Requests</h2>
            <form method="get" class="d-flex gap-2">
              <select class="form-select form-select-sm" name="type">
                <option value="">All Types</option>
                <option value="TEAM">Team Formation</option>
                <option value="GUIDANCE">Guidance Needed</option>
                <option value="HACKATHON">Hackathon Partner</option>
                <option value="OTHER">Other</option>
              </select>
              <select class="form-select form-select-sm" name="urgency">
                <option value="">All Urgency</option>
                <option value="HIGH">High</option>
                <option value="MEDIUM">Medium</option>
                <option value="LOW">Low</option>
              </select>
              <select class="form-select form-select-sm" name="order">
                <option value="date">Newest</option>
                <option value="urgency">By Urgency</option>
              </select>
              <button class="btn btn-light btn-sm" type="submit">Filter</button>
            </form>
          </div>
          <div class="card-body" style="max-height: 70vh; overflow:auto;">
            {% for r in requests %}
              <div class="border rounded p-3 mb-3" data-id="{{ r.id }}">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-semibold">{{ r.title }} <span class="badge bg-secondary ms-2">{{ r.get_request_type_display }}</span></div>
                    <div class="text-muted small">By {{ r.author.name }} • {{ r.created_at|date:"M d, Y H:i" }} • <span class="badge bg-warning text-dark">{{ r.urgency }}</span> • {{ r.status }}</div>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-success accept-btn">Accept/Join</button>
                    <button class="btn btn-sm btn-outline-secondary bookmark-btn">Bookmark</button>
                    <button class="btn btn-sm btn-outline-danger report-btn">Report</button>
                  </div>
                </div>
                <div class="mt-2">
                  <div class="desc-short">{{ r.description|truncatechars:160 }}</div>
                  <div class="desc-full d-none">{{ r.description }}</div>
                  <a href="#" class="read-more">Read More</a>
                </div>
                <div class="mt-2 text-muted small">Skills: {{ r.required_skills }} • Tags: {{ r.tags }}</div>
                <div class="mt-3">
                  <div class="d-flex align-items-center gap-2 mb-2">
                    {% if request.user.profile_photo %}
                      <img src="{{ request.user.profile_photo.url }}" alt="Avatar" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
                    {% endif %}
                    <input type="text" class="form-control form-control-sm comment-input" maxlength="500" placeholder="Write a comment...">
                    <button class="btn btn-sm btn-warning comment-submit" style="background: linear-gradient(135deg, var(--orange-primary), var(--orange-dark)); border:none;">Post</button>
                  </div>
                  <div class="comments small"></div>
                </div>
                {% if r.team %}
                  <div class="mt-3 p-2 border rounded">
                    <div class="fw-semibold">Team</div>
                    <div class="small">Members: {{ r.team.memberships.count }}
                      {% for m in r.team.memberships.all %}
                        • {{ m.user.name }}{% if m.approved %} (approved){% endif %}
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
              </div>
            {% empty %}
              <p class="text-muted">No requests yet.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  function getCookie(name){const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return v?v.pop():''}
  function setBtnState(btn, text, disabled){btn.textContent=text;btn.disabled=!!disabled}
  document.addEventListener('DOMContentLoaded',()=>{
    document.querySelectorAll('.read-more').forEach(a=>{a.addEventListener('click',(e)=>{e.preventDefault();const card=a.closest('[data-id]');if(!card)return;const short=card.querySelector('.desc-short');const full=card.querySelector('.desc-full');if(!short||!full)return;const isHidden=full.classList.contains('d-none');if(isHidden){full.classList.remove('d-none');a.textContent='Read Less'}else{full.classList.add('d-none');a.textContent='Read More'}})})
    document.querySelectorAll('.accept-btn').forEach(b=>{b.addEventListener('click',async()=>{const card=b.closest('[data-id]');const id=card.dataset.id;try{b.disabled=true;const r=await fetch(`/helpgrow/${id}/accept/`,{method:'POST',credentials:'same-origin',headers:{'X-CSRFToken':getCookie('csrftoken')}});if(!r.ok){setBtnState(b,'Accept/Join',false);return}setBtnState(b,'Accepted',true)}catch(e){setBtnState(b,'Accept/Join',false)}})})
    document.querySelectorAll('.bookmark-btn').forEach(b=>{b.addEventListener('click',async()=>{const card=b.closest('[data-id]');const id=card.dataset.id;try{const r=await fetch(`/helpgrow/${id}/bookmark/`,{method:'POST',credentials:'same-origin',headers:{'X-CSRFToken':getCookie('csrftoken')}});if(r.ok){const j=await r.json();b.classList.toggle('active',j.bookmarked);b.textContent=j.bookmarked?'Bookmarked':'Bookmark'}}catch(e){}})})
    document.querySelectorAll('.report-btn').forEach(b=>{b.addEventListener('click',async()=>{const card=b.closest('[data-id]');const id=card.dataset.id;const reason=prompt('Reason');if(!reason)return;try{b.disabled=true;const r=await fetch(`/helpgrow/${id}/report/`,{method:'POST',credentials:'same-origin',headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':getCookie('csrftoken')},body:`reason=${encodeURIComponent(reason)}`});setBtnState(b,r.ok?'Reported':'Report',r.ok)}catch(e){setBtnState(b,'Report',false)}})})
    document.querySelectorAll('.comment-submit').forEach(b=>{b.addEventListener('click',async()=>{const wrapper=b.closest('[data-id]');const id=wrapper.dataset.id;const input=wrapper.querySelector('.comment-input');const list=wrapper.querySelector('.comments');const content=(input.value||'').trim();if(!content)return; try{b.disabled=true;const r=await fetch(`/helpgrow/${id}/comment/`,{method:'POST',credentials:'same-origin',headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':getCookie('csrftoken')},body:`content=${encodeURIComponent(content)}`});b.disabled=false; if(r.ok){const j=await r.json();const el=document.createElement('div');el.innerHTML=`<div><span class='fw-semibold'>${j.user}</span> <span class='text-muted'>${new Date(j.created_at).toLocaleString()}</span></div><div>${j.content}</div>`;list.prepend(el);input.value=''}}catch(e){b.disabled=false}})})
  })
</script>
{% endblock content %}
